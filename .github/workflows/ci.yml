name: CI - Test, Security, Build, Sign & Attest

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  contents: read

jobs:
  build_test_secure:
    name: Test, Security Scans, Build & Supply Chain
    runs-on: ubuntu-latest

    # Fine-grained permissions for this job
    permissions:
      contents: read
      packages: write # Needed to push image to GHCR
      id-token: write # Needed for OIDC (Cosign, attestations)
      security-events: write # Needed to upload SARIF to Security tab

    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: testuser
          POSTGRES_PASSWORD: testpass
          POSTGRES_DB: testdb
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U testuser -d testdb"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    env:
      IMAGE_NAME: ghcr.io/${{ github.repository }}
      DATABASE_URL: postgresql+psycopg://testuser:testpass@localhost:5432/testdb

    steps:
      # --- Checkout source ---
      - name: Checkout repository
        uses: actions/checkout@v5

      # --- Python setup rely on locked requirements ---
      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.12"
          cache: "pip"
          cache-dependency-path: |
            requirements.txt
            requirements-dev.txt

      # --- Install dependencies from hashed requirements ---
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt -r requirements-dev.txt

      # --- Tests + coverage gate ---
      - name: Run tests with coverage (min 85%)
        run: pytest --cov=app --cov-fail-under=85 -q

      # --- SCA: pip-audit on requirements files ---
      - name: Scan dependencies for vulnerabilities (pip-audit)
        uses: pypa/gh-action-pip-audit@v1.1.0
        with:
          # Audit against the locked dependency definitions
          inputs: requirements.txt requirements-dev.txt
          require-hashes: true
          vulnerability-service: osv

      # --- SBOM: CycloneDX ---
      - name: Generate SBOM (CycloneDX)
        run: |
          pip install cyclonedx-bom
          cyclonedx-py --format json -o sbom.json

      - name: Upload SBOM artifact
        uses: actions/upload-artifact@v4
        with:
          name: sbom-cyclonedx
          path: sbom.json

      # --- PR-only: Trivy filesystem scan (shift-left) ---
      - name: Trivy filesystem scan (PR)
        if: github.event_name == 'pull_request'
        uses: aquasecurity/trivy-action@0.28.0
        with:
          scan-type: fs
          scan-ref: .
          format: sarif
          output: trivy-fs.sarif
          severity: CRITICAL,HIGH
          ignore-unfixed: true

      - name: Upload Trivy FS SARIF (PR)
        if: github.event_name == 'pull_request'
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: trivy-fs.sarif

      # --- PR-only: Trivy config scan (IaC, Dockerfile, etc.) ---
      - name: Trivy config scan (PR)
        if: github.event_name == 'pull_request'
        uses: aquasecurity/trivy-action@0.28.0
        with:
          scan-type: config
          scan-ref: .
          format: sarif
          output: trivy-config.sarif

      - name: Upload Trivy Config SARIF (PR)
        if: github.event_name == 'pull_request'
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: trivy-config.sarif

      # --- Build & push image (only on main) ---
      - name: Set up Docker Buildx
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: docker/setup-buildx-action@v3.11.1

      - name: Log in to GitHub Container Registry
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: docker/login-action@v3.6.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Docker image
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        id: build-and-push
        uses: docker/build-push-action@v6.18.0
        with:
          context: .
          file: ./docker/Dockerfile
          push: true
          tags: ${{ env.IMAGE_NAME }}:${{ github.sha }}
          provenance: false

      # --- Trivy: scan built image ---
      - name: Trivy image scan (main)
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: aquasecurity/trivy-action@0.28.0
        with:
          scan-type: image
          image-ref: ${{ env.IMAGE_NAME }}:${{ github.sha }}
          format: sarif
          output: trivy-image.sarif
          severity: CRITICAL,HIGH
          ignore-unfixed: true

      - name: Upload Trivy image SARIF
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: trivy-image.sarif

      # --- Cosign: install ---
      - name: Install Cosign
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: sigstore/cosign-installer@v3.10.0

      # --- Cosign: sign image (keyless via OIDC) ---
      - name: Sign container image
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          cosign sign --yes \
            ${{ env.IMAGE_NAME }}@${{ steps.build-and-push.outputs.digest }}

      # --- Cosign: verify signature inside CI ---
      - name: Verify image signature
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          cosign verify \
            --certificate-oidc-issuer https://token.actions.githubusercontent.com \
            --certificate-identity-regexp "https://github.com/${{ github.repository }}/\.github/workflows/ci\.yml@.*" \
            ${{ env.IMAGE_NAME }}@${{ steps.build-and-push.outputs.digest }}

      # --- SLSA provenance attestation ---
      - name: Attest build provenance (SLSA)
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: actions/attest-build-provenance@v3
        with:
          subject-name: ${{ env.IMAGE_NAME }}
          subject-digest: ${{ steps.build-and-push.outputs.digest }}
          push-to-registry: true

      # --- Verify SLSA provenance (Cosign attestation) ---
      - name: Verify SLSA provenance attestation
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          cosign verify-attestation \
            --type slsaprovenance \
            --certificate-oidc-issuer https://token.actions.githubusercontent.com \
            --certificate-identity-regexp "https://github.com/${{ github.repository }}/\.github/workflows/ci\.yml@.*" \
            ${{ env.IMAGE_NAME }}@${{ steps.build-and-push.outputs.digest }}
